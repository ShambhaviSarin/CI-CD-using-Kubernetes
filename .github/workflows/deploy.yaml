name: CI-CD-Kubernetes

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # 1. Checkout repo
    - name: Checkout code
      uses: actions/checkout@v4

    # 2. Setup Go and modules
    - name: Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.20'

    - name: Tidy modules
      run: go mod tidy

    - name: Run Go Tests
      run: go test ./... -v

    # 3. Install Minikube
    - name: Install Minikube
      run: |
        curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
        chmod +x minikube-linux-amd64
        sudo mv minikube-linux-amd64 /usr/local/bin/minikube

    # 4. Start Minikube
    - name: Start Minikube
      run: |
        minikube start --driver=docker --kubernetes-version=v1.28.0
        kubectl get nodes

    # 5. Configure Docker to use Minikube
    - name: Configure Docker for Minikube
      run: |
        eval $(minikube -p minikube docker-env)

    # 6. Log in to GHCR
    - name: Log in to GHCR
      run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

    # 7. Build and push Docker image to GHCR
    - name: Build and push Docker image
      run: |
        docker build -t ghcr.io/${{ github.repository_owner }}/helloworld:latest .
        docker push ghcr.io/${{ github.repository_owner }}/helloworld:latest

    # 8. Apply Kubernetes manifests
    - name: Apply Kubernetes manifests
      run: kubectl apply -f application.yaml

    # 9. Wait for pods to be ready
    - name: Wait for pods
      run: |
        kubectl wait --for=condition=Ready pods -l app=helloworld -n helloworld --timeout=90s

    # 10. Get Minikube service URL
    - name: Get Minikube service URL
      id: url
      run: |
        echo "SERVICE_URL=$(minikube service helloworld-service -n helloworld --url)" >> $GITHUB_ENV

    # 11. Test API endpoint via curl
    - name: Test API endpoint via curl
      run: |
        echo "Testing API at $SERVICE_URL"
        curl -v $SERVICE_URL
