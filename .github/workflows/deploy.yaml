name: CI-CD-Kubernetes

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # 1. Checkout repo
    - name: Checkout code
      uses: actions/checkout@v4

    # 2. Setup Go
    - name: Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.20'

    # 3. Tidy modules
    - name: Tidy modules
      run: go mod tidy

    # 4. Run Go Tests
    - name: Run Go Tests
      run: go test ./... -v

    # 5. Install Minikube
    - name: Install Minikube
      run: |
        curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
        chmod +x minikube-linux-amd64
        sudo mv minikube-linux-amd64 /usr/local/bin/minikube

    # 6. Start Minikube with enough resources
    - name: Start Minikube
      run: |
        minikube start --driver=docker --memory=4096 --cpus=2 --kubernetes-version=v1.28.0
        kubectl get nodes

    # 7. Start Minikube
    - name: Start Minikube
      run: |
        minikube start --driver=docker --memory=4096 --cpus=2 --kubernetes-version=v1.28.0
        kubectl get nodes

    # 8. Build Docker image inside Minikube
    - name: Build Docker image inside Minikube
      run: |
        eval $(minikube -p minikube docker-env)
        docker build -t helloworld:local .

    # 9. Create namespace
    - name: Create namespace
      run: kubectl create namespace helloworld || true

    # 10. Apply Kubernetes manifests
    - name: Apply Kubernetes manifests
      run: kubectl apply -f application.yaml

    # 11. Debug pod status
    - name: Describe deployment
      run: kubectl describe deployment helloworld-deployment -n helloworld

    - name: Get pods status
      run: kubectl get pods -n helloworld -o wide

    - name: Get pod events
      run: kubectl get events -n helloworld --sort-by='.metadata.creationTimestamp'

    # 12. Wait for pods to be ready
    - name: Wait for pods
      run: |
        kubectl wait --for=condition=Ready pods -l app=helloworld -n helloworld --timeout=120s || true
        kubectl get pods -n helloworld

    # 13. Get Minikube service URL
    - name: Get service URL
      run: |
        export SERVICE_URL=$(minikube service helloworld-service -n helloworld --url)
        echo "Service URL: $SERVICE_URL"

    # 14. Test API endpoint
    - name: Test API via curl
      run: |
        curl -v $(minikube service helloworld-service -n helloworld --url)
