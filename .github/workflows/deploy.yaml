name: CI-CD-Kubernetes

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # 1. Checkout repo
    - name: Checkout code
      uses: actions/checkout@v4

    # 2. Setup Go
    - name: Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.20'

    # 3. Tidy modules
    - name: Tidy modules
      run: go mod tidy

    # 4. Run Go Tests
    - name: Run Go Tests
      run: go test ./... -v

    # 5. Install Minikube
    - name: Install Minikube
      run: |
        curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
        chmod +x minikube-linux-amd64
        sudo mv minikube-linux-amd64 /usr/local/bin/minikube

    # 6. Start Minikube
    - name: Start Minikube
      run: |
        minikube start --driver=docker --kubernetes-version=v1.28.0
        kubectl get nodes

    # 7. Configure Docker to use Minikube
    - name: Use Minikube Docker
      run: eval $(minikube -p minikube docker-env)

    # 8. Build Docker image inside Minikube
    - name: Build Docker image
      run: docker build -t helloworld:local .

    # 9. Create namespace
    - name: Create namespace
      run: kubectl create namespace helloworld || true

    # 10. Apply Kubernetes manifests
    - name: Apply Kubernetes manifests
      run: kubectl apply -f application.yaml

    # 11. Wait for pods to be ready
    - name: Wait for pods
      run: |
        kubectl wait --for=condition=Ready pods -l app=helloworld -n helloworld --timeout=180s

    # 12. Get service URL
    - name: Get Minikube service URL
      id: url
      run: |
        echo "SERVICE_URL=$(minikube service helloworld-service -n helloworld --url)" >> $GITHUB_ENV

    # 13. Test API endpoint
    - name: Test API endpoint via curl
      run: |
        echo "Testing API at $SERVICE_URL"
        curl -v $SERVICE_URL
